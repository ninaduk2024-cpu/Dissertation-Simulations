using QuantumOptics
using Statistics
using Random
using Plots

b = SpinBasis(1//2)
id = identityoperator(b)
Ïƒz = sigmaz(b)
Ïƒx = sigmax(b)
Ïƒy = sigmay(b)


Ïƒz1 = tensor(Ïƒz, id)
Ïƒz2 = tensor(id, Ïƒz)
Ïƒx1 = tensor(Ïƒx, id)
Ïƒx2 = tensor(id, Ïƒx)


Ïˆplus = normalize(spinup(b) + spindown(b))
Ïˆ0 = tensor(Ïˆplus, Ïˆplus)
Ï0 = dm(Ïˆ0)

Î³ = 0.01                    
tspan = [0, 5]          
nshots = 5000              
correlated_strength = 0.3 
collapse_ops = [sqrt(Î³)*Ïƒz1, sqrt(Î³)*Ïƒz2]


results1 = zeros(Int, nshots)
results2 = zeros(Int, nshots)

for i in 1:nshots
    Bc = randn() * correlated_strength
    H = Bc * (Ïƒz1 + Ïƒz2) 


    tout, Ït = timeevolution.master(tspan, Ï0, H, collapse_ops)
    Ïf = Ït[end]


  p1 = real(expect(Ïƒx1, Ïf))
  p2 = real(expect(Ïƒx2, Ïf))

    results1[i] = rand() < (1 + p1)/2 ? 1 : 0
    results2[i] = rand() < (1 + p2)/2 ? 1 : 0
end



r = cor(results1, results2)
println("ğŸ“ˆ Measured Pearson correlation r = $r")


histogram2d(results1, results2,
    nbins=(2,2),
    xlabel="NV1 outcome",
    ylabel="NV2 outcome",
    title="Joint Detection Histogram",
    xticks=([0,1], ["0","1"]),
    yticks=([0,1], ["0","1"]),
    cbar_title="Counts")
